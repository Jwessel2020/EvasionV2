# ML Risk Prediction System - Architecture Diagram

## System Overview

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           EVASION V2 - ML RISK PREDICTION SYSTEM                        │
│                                                                                         │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐ │
│  │   Data Layer    │───▶│  Training Layer │───▶│  Storage Layer  │───▶│ Serving Layer│ │
│  │   (PostgreSQL)  │    │    (Python)     │    │  (PostgreSQL)   │    │  (Next.js)   │ │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘    └──────────────┘ │
│                                                                               │         │
│                                                                               ▼         │
│                                                                    ┌──────────────────┐ │
│                                                                    │  Presentation    │ │
│                                                                    │  (React/Mapbox)  │ │
│                                                                    └──────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Detailed Architecture

### 1. Data Source Layer

```
┌───────────────────────────────────────────────────────────────────────────────────────┐
│                              POSTGRESQL DATABASE                                       │
│                                                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                         traffic_violations (1M+ records)                         │ │
│  │                                                                                  │ │
│  │  ┌──────────────┬──────────────┬──────────────┬──────────────┬───────────────┐  │ │
│  │  │     id       │   latitude   │  longitude   │ violation_   │ detection_    │  │ │
│  │  │   (UUID)     │   (FLOAT)    │   (FLOAT)    │ timestamp    │ method        │  │ │
│  │  ├──────────────┼──────────────┼──────────────┼──────────────┼───────────────┤  │ │
│  │  │ speed_limit  │ actual_speed │ speed_over   │ alcohol_     │ accident_     │  │ │
│  │  │   (INT)      │    (INT)     │    (INT)     │ related      │ related       │  │ │
│  │  └──────────────┴──────────────┴──────────────┴──────────────┴───────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                    violation_hotspots (Pre-aggregated Stats)                     │ │
│  │                                                                                  │ │
│  │  ┌──────────────┬──────────────┬──────────────┬──────────────┬───────────────┐  │ │
│  │  │   grid_id    │  hour_bucket │ day_of_week  │ stop_count   │  avg_speed    │  │ │
│  │  │  (STRING)    │    (INT)     │    (INT)     │    (INT)     │   (FLOAT)     │  │ │
│  │  └──────────────┴──────────────┴──────────────┴──────────────┴───────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────────────────────────────────────┘
```

---

### 2. ML Training Pipeline

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              ML TRAINING PIPELINE                                       │
│                              ml/train_risk_model.py                                     │
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │                         PHASE 1: DATA EXTRACTION                                 │   │
│  │                                                                                  │   │
│  │    ┌─────────────┐         SQL Query          ┌─────────────────────────────┐   │   │
│  │    │  PostgreSQL │ ─────────────────────────▶ │    Raw DataFrame            │   │   │
│  │    │  Database   │  SELECT latitude,          │    ┌─────────────────────┐  │   │   │
│  │    │             │  longitude, timestamp,     │    │ 1,234,567 rows      │  │   │   │
│  │    └─────────────┘  speed_over, detection,    │    │ 12 columns          │  │   │   │
│  │                     alcohol, accident         │    └─────────────────────┘  │   │   │
│  │                     FROM traffic_violations   └─────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                           │                                             │
│                                           ▼                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │                         PHASE 2: FEATURE ENGINEERING                             │   │
│  │                         ml/feature_engineering.py                                │   │
│  │                                                                                  │   │
│  │  ┌───────────────────────────────────────────────────────────────────────────┐  │   │
│  │  │                      SPATIAL FEATURES                                      │  │   │
│  │  │                                                                            │  │   │
│  │  │   Raw Coordinates           Grid Binning (0.001° ≈ 100m)                  │  │   │
│  │  │   ┌─────────────┐          ┌─────────────────────────────────┐            │  │   │
│  │  │   │ lat: 39.0458│   ───▶   │ grid_lat: 39.046               │            │  │   │
│  │  │   │ lng:-77.1201│          │ grid_lng: -77.120               │            │  │   │
│  │  │   └─────────────┘          │ grid_id: "39.046_-77.120"       │            │  │   │
│  │  │                            └─────────────────────────────────┘            │  │   │
│  │  │                                                                            │  │   │
│  │  │   Spatial Density: COUNT of historical stops per grid cell                │  │   │
│  │  └───────────────────────────────────────────────────────────────────────────┘  │   │
│  │                                                                                  │   │
│  │  ┌───────────────────────────────────────────────────────────────────────────┐  │   │
│  │  │                      TEMPORAL FEATURES (Cyclical Encoding)                 │  │   │
│  │  │                                                                            │  │   │
│  │  │   Hour of Day (0-23)                  Day of Week (0-6)                   │  │   │
│  │  │   ┌─────────────────────────┐        ┌─────────────────────────┐          │  │   │
│  │  │   │                         │        │                         │          │  │   │
│  │  │   │  hour_sin = sin(2π×h/24)│        │  dow_sin = sin(2π×d/7) │          │  │   │
│  │  │   │  hour_cos = cos(2π×h/24)│        │  dow_cos = cos(2π×d/7) │          │  │   │
│  │  │   │                         │        │                         │          │  │   │
│  │  │   │     ⟲ Circular time     │        │     ⟲ Circular week    │          │  │   │
│  │  │   │       encoding          │        │       encoding          │          │  │   │
│  │  │   └─────────────────────────┘        └─────────────────────────┘          │  │   │
│  │  │                                                                            │  │   │
│  │  │   Month of Year (1-12)                                                    │  │   │
│  │  │   ┌─────────────────────────┐                                             │  │   │
│  │  │   │ month_sin = sin(2π×m/12)│        Why Cyclical Encoding?              │  │   │
│  │  │   │ month_cos = cos(2π×m/12)│        ─────────────────────────           │  │   │
│  │  │   └─────────────────────────┘        • Hour 23 and Hour 0 are            │  │   │
│  │  │                                        adjacent (not 23 apart!)          │  │   │
│  │  │                                      • Preserves temporal continuity     │  │   │
│  │  └───────────────────────────────────────────────────────────────────────────┘  │   │
│  │                                                                                  │   │
│  │  ┌───────────────────────────────────────────────────────────────────────────┐  │   │
│  │  │                      HISTORICAL FEATURES                                   │  │   │
│  │  │                                                                            │  │   │
│  │  │   Per Grid Cell:                                                          │  │   │
│  │  │   ┌─────────────────────────────────────────────────────────────────────┐ │  │   │
│  │  │   │ stops_7d   │ stops_30d  │ stops_90d  │ avg_speed_over │ grid_count │ │  │   │
│  │  │   ├────────────┼────────────┼────────────┼────────────────┼────────────┤ │  │   │
│  │  │   │  Rolling   │  Rolling   │  Rolling   │   Mean speed   │   Total    │ │  │   │
│  │  │   │  7-day     │  30-day    │  90-day    │   violation    │   stops    │ │  │   │
│  │  │   │  count     │  count     │  count     │   in cell      │   ever     │ │  │   │
│  │  │   └─────────────────────────────────────────────────────────────────────┘ │  │   │
│  │  └───────────────────────────────────────────────────────────────────────────┘  │   │
│  │                                                                                  │   │
│  │  ┌───────────────────────────────────────────────────────────────────────────┐  │   │
│  │  │                      CONTEXTUAL FEATURES                                   │  │   │
│  │  │                                                                            │  │   │
│  │  │   Binary Flags:           Distribution in Grid:                           │  │   │
│  │  │   ┌──────────────────┐    ┌─────────────────────────────────────────────┐ │  │   │
│  │  │   │ is_weekend: 0/1  │    │ radar_pct    │ Percentage detected by radar │ │  │   │
│  │  │   │ is_rush_hour: 0/1│    │ laser_pct    │ Percentage detected by laser │ │  │   │
│  │  │   └──────────────────┘    │ alcohol_pct  │ Percentage alcohol-related   │ │  │   │
│  │  │                           │ accident_pct │ Percentage accident-related  │ │  │   │
│  │  │   Rush Hour: 7-9 AM       └─────────────────────────────────────────────┘ │  │   │
│  │  │   or 4-7 PM                                                               │  │   │
│  │  └───────────────────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                           │                                             │
│                                           ▼                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │                         PHASE 3: TRAINING DATA CREATION                          │   │
│  │                                                                                  │   │
│  │   ┌────────────────────────────────────────────────────────────────────────┐    │   │
│  │   │                    POSITIVE SAMPLES (Label = 1)                        │    │   │
│  │   │                                                                         │    │   │
│  │   │    Grid cells where traffic stops actually occurred                    │    │   │
│  │   │    ┌───────────────────────────────────────────────────────────────┐   │    │   │
│  │   │    │  Grid: 39.046_-77.120  │  Hour: 14  │  Day: 2  │  Label: 1   │   │    │   │
│  │   │    │  Grid: 39.047_-77.121  │  Hour: 8   │  Day: 1  │  Label: 1   │   │    │   │
│  │   │    │  Grid: 39.045_-77.119  │  Hour: 17  │  Day: 4  │  Label: 1   │   │    │   │
│  │   │    │                        ...                                    │   │    │   │
│  │   │    └───────────────────────────────────────────────────────────────┘   │    │   │
│  │   └────────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                                  │   │
│  │   ┌────────────────────────────────────────────────────────────────────────┐    │   │
│  │   │                    NEGATIVE SAMPLES (Label = 0)                        │    │   │
│  │   │                                                                         │    │   │
│  │   │    Random sampling from grid cells without stops (3:1 ratio)           │    │   │
│  │   │    ┌───────────────────────────────────────────────────────────────┐   │    │   │
│  │   │    │  Grid: 39.048_-77.122  │  Hour: 10  │  Day: 3  │  Label: 0   │   │    │   │
│  │   │    │  Grid: 39.044_-77.118  │  Hour: 22  │  Day: 6  │  Label: 0   │   │    │   │
│  │   │    │  Grid: 39.049_-77.123  │  Hour: 3   │  Day: 0  │  Label: 0   │   │    │   │
│  │   │    │                        ...                                    │   │    │   │
│  │   │    └───────────────────────────────────────────────────────────────┘   │    │   │
│  │   └────────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                                  │   │
│  │   Combined Training Dataset:                                                    │   │
│  │   ┌─────────────────────────────────────────────────────────────────────────┐  │   │
│  │   │  ~500K positive samples + ~1.5M negative samples = ~2M training rows    │  │   │
│  │   └─────────────────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                           │                                             │
│                                           ▼                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │                         PHASE 4: MODEL TRAINING                                  │   │
│  │                                                                                  │   │
│  │   ┌─────────────────────────────────────────────────────────────────────────┐   │   │
│  │   │                          XGBoost Classifier                              │   │   │
│  │   │                                                                          │   │   │
│  │   │   Configuration:                                                         │   │   │
│  │   │   ┌────────────────────────────────────────────────────────────────┐    │   │   │
│  │   │   │  n_estimators: 200       │  max_depth: 6                       │    │   │   │
│  │   │   │  learning_rate: 0.1      │  min_child_weight: 10               │    │   │   │
│  │   │   │  subsample: 0.8          │  colsample_bytree: 0.8              │    │   │   │
│  │   │   │  objective: binary:logistic                                     │    │   │   │
│  │   │   └────────────────────────────────────────────────────────────────┘    │   │   │
│  │   │                                                                          │   │   │
│  │   │   5-Fold Cross-Validation:                                              │   │   │
│  │   │   ┌────────────────────────────────────────────────────────────────┐    │   │   │
│  │   │   │                                                                 │    │   │   │
│  │   │   │   Fold 1: ████████░░ Train │ ██ Valid │ AUC: 0.81             │    │   │   │
│  │   │   │   Fold 2: ██░░████████ Train │ ██ Valid │ AUC: 0.83             │    │   │   │
│  │   │   │   Fold 3: ████░░████ Train │ ██ Valid │ AUC: 0.82             │    │   │   │
│  │   │   │   Fold 4: ██████░░██ Train │ ██ Valid │ AUC: 0.80             │    │   │   │
│  │   │   │   Fold 5: ████████░░ Train │ ██ Valid │ AUC: 0.84             │    │   │   │
│  │   │   │   ─────────────────────────────────────────────                │    │   │   │
│  │   │   │   Mean AUC: 0.82 (+/- 0.015)                                   │    │   │   │
│  │   │   │                                                                 │    │   │   │
│  │   │   └────────────────────────────────────────────────────────────────┘    │   │   │
│  │   └─────────────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                                  │   │
│  │   ┌─────────────────────────────────────────────────────────────────────────┐   │   │
│  │   │                    Probability Calibration (Platt Scaling)               │   │   │
│  │   │                                                                          │   │   │
│  │   │      Raw XGBoost         Calibration          Calibrated                │   │   │
│  │   │      Predictions    ───▶   (Sigmoid)    ───▶  Probabilities             │   │   │
│  │   │                                                                          │   │   │
│  │   │   ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐       │   │   │
│  │   │   │ Score: 0.65     │   │ CalibratedCV    │   │ Prob: 0.58      │       │   │   │
│  │   │   │ (overconfident) │   │ (5-fold)        │   │ (well-calibrated│       │   │   │
│  │   │   └─────────────────┘   └─────────────────┘   └─────────────────┘       │   │   │
│  │   │                                                                          │   │   │
│  │   │   Why Calibrate?                                                        │   │   │
│  │   │   • XGBoost scores are not true probabilities                           │   │   │
│  │   │   • Calibration ensures P(stop)=0.7 means 70% of similar cases had stop │   │   │
│  │   │   • Critical for meaningful risk levels                                 │   │   │
│  │   └─────────────────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                           │                                             │
│                                           ▼                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │                         PHASE 5: PREDICTION GENERATION                           │   │
│  │                                                                                  │   │
│  │   Generate predictions for ALL grid × time combinations:                        │   │
│  │                                                                                  │   │
│  │   ┌─────────────────────────────────────────────────────────────────────────┐   │   │
│  │   │                                                                          │   │   │
│  │   │   Grid Cells        ×   Hours   ×   Days   =   Total Predictions        │   │   │
│  │   │   (~1,000 unique)       (24)        (7)         ~168,000                 │   │   │
│  │   │                                                                          │   │   │
│  │   │   For each combination:                                                  │   │   │
│  │   │   ┌────────────────────────────────────────────────────────────────┐    │   │   │
│  │   │   │  1. Create feature vector                                      │    │   │   │
│  │   │   │  2. Run through calibrated model                               │    │   │   │
│  │   │   │  3. Get probability (0.0 - 1.0)                                │    │   │   │
│  │   │   │  4. Compute factor contributions (SHAP-like)                   │    │   │   │
│  │   │   │  5. Store prediction record                                    │    │   │   │
│  │   │   └────────────────────────────────────────────────────────────────┘    │   │   │
│  │   │                                                                          │   │   │
│  │   └─────────────────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

### 3. Prediction Storage Layer

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              PREDICTION STORAGE LAYER                                   │
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │                         police_predictions Table                                 │   │
│  │                                                                                  │   │
│  │   Schema:                                                                        │   │
│  │   ┌──────────────────────────────────────────────────────────────────────────┐  │   │
│  │   │  Column         │  Type           │  Description                         │  │   │
│  │   ├─────────────────┼─────────────────┼──────────────────────────────────────┤  │   │
│  │   │  id             │  UUID           │  Primary key                         │  │   │
│  │   │  latitude       │  FLOAT          │  Grid cell center latitude           │  │   │
│  │   │  longitude      │  FLOAT          │  Grid cell center longitude          │  │   │
│  │   │  probability    │  FLOAT          │  Predicted stop probability (0-1)    │  │   │
│  │   │  time_window    │  VARCHAR        │  "hour_14_day_2" format              │  │   │
│  │   │  factors        │  JSONB          │  Contributing factors                │  │   │
│  │   │  model_version  │  VARCHAR        │  "v1.0.0"                            │  │   │
│  │   │  valid_until    │  TIMESTAMP      │  Prediction expiry (7 days)          │  │   │
│  │   │  created_at     │  TIMESTAMP      │  Record creation time                │  │   │
│  │   └──────────────────────────────────────────────────────────────────────────┘  │   │
│  │                                                                                  │   │
│  │   Factors JSONB Structure:                                                      │   │
│  │   ┌──────────────────────────────────────────────────────────────────────────┐  │   │
│  │   │  {                                                                        │  │   │
│  │   │    "model_version": "v1.0.0",                                            │  │   │
│  │   │    "grid_stop_count": 145,                                               │  │   │
│  │   │    "is_rush_hour": true,                                                 │  │   │
│  │   │    "is_weekend": false,                                                  │  │   │
│  │   │    "avg_speed_over": 12.5,                                               │  │   │
│  │   │    "radar_pct": 0.65,                                                    │  │   │
│  │   │    "feature_importance": {                                               │  │   │
│  │   │      "grid_stop_count": 0.22,                                            │  │   │
│  │   │      "hour_sin": 0.15,                                                   │  │   │
│  │   │      "is_rush_hour": 0.12,                                               │  │   │
│  │   │      ...                                                                  │  │   │
│  │   │    }                                                                      │  │   │
│  │   │  }                                                                        │  │   │
│  │   └──────────────────────────────────────────────────────────────────────────┘  │   │
│  │                                                                                  │   │
│  │   Indexes:                                                                      │   │
│  │   ┌──────────────────────────────────────────────────────────────────────────┐  │   │
│  │   │  • (time_window, latitude, longitude) - Primary query pattern            │  │   │
│  │   │  • (valid_until) - For cleanup of expired predictions                    │  │   │
│  │   │  • (probability DESC) - For top-risk queries                             │  │   │
│  │   └──────────────────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

### 4. API Serving Layer

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              API SERVING LAYER (Next.js)                                │
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │                    /api/predictions/risk                                         │   │
│  │                    Point-based Risk Query                                        │   │
│  │                                                                                  │   │
│  │   Request:                                                                       │   │
│  │   ┌──────────────────────────────────────────────────────────────────────────┐  │   │
│  │   │  GET /api/predictions/risk?lat=39.0458&lng=-77.1201&hour=14&day=2        │  │   │
│  │   └──────────────────────────────────────────────────────────────────────────┘  │   │
│  │                                           │                                      │   │
│  │                                           ▼                                      │   │
│  │   Processing:                                                                    │   │
│  │   ┌──────────────────────────────────────────────────────────────────────────┐  │   │
│  │   │  1. Round lat/lng to grid cell: 39.046_-77.120                           │  │   │
│  │   │  2. Build time_window: "hour_14_day_2"                                   │  │   │
│  │   │  3. Query police_predictions WHERE time_window AND location             │  │   │
│  │   │  4. Find nearby predictions within radius (Haversine distance)          │  │   │
│  │   │  5. Extract factor contributions                                         │  │   │
│  │   │  6. Determine risk level from probability                                │  │   │
│  │   └──────────────────────────────────────────────────────────────────────────┘  │   │
│  │                                           │                                      │   │
│  │                                           ▼                                      │   │
│  │   Response:                                                                      │   │
│  │   ┌──────────────────────────────────────────────────────────────────────────┐  │   │
│  │   │  {                                                                        │  │   │
│  │   │    "success": true,                                                       │  │   │
│  │   │    "data": {                                                              │  │   │
│  │   │      "location": { "lat": 39.046, "lng": -77.120, "gridCell": "..." },   │  │   │
│  │   │      "prediction": {                                                      │  │   │
│  │   │        "probability": 0.73,                                               │  │   │
│  │   │        "riskLevel": "high",                                               │  │   │
│  │   │        "confidence": 0.85                                                 │  │   │
│  │   │      },                                                                   │  │   │
│  │   │      "factors": [                                                         │  │   │
│  │   │        { "name": "rush_hour", "impact": "+15%" },                         │  │   │
│  │   │        { "name": "historical_density", "impact": "+22%" }                 │  │   │
│  │   │      ],                                                                   │  │   │
│  │   │      "nearby": [ { "lat": ..., "lng": ..., "probability": ... } ]        │  │   │
│  │   │    }                                                                      │  │   │
│  │   │  }                                                                        │  │   │
│  │   └──────────────────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │                    /api/predictions/heatmap                                      │   │
│  │                    Viewport-based Heatmap Data                                   │   │
│  │                                                                                  │   │
│  │   Request:                                                                       │   │
│  │   ┌──────────────────────────────────────────────────────────────────────────┐  │   │
│  │   │  GET /api/predictions/heatmap?bounds=-77.2,39.0,-77.1,39.1&hour=14&day=2 │  │   │
│  │   └──────────────────────────────────────────────────────────────────────────┘  │   │
│  │                                           │                                      │   │
│  │                                           ▼                                      │   │
│  │   Processing:                                                                    │   │
│  │   ┌──────────────────────────────────────────────────────────────────────────┐  │   │
│  │   │  1. Parse bounds: minLng, minLat, maxLng, maxLat                         │  │   │
│  │   │  2. Build time_window from hour/day (or use current)                     │  │   │
│  │   │  3. Query predictions within bounding box                                │  │   │
│  │   │  4. Limit to 5000 points (ordered by probability DESC)                   │  │   │
│  │   │  5. Format as GeoJSON FeatureCollection                                  │  │   │
│  │   │  6. Compute statistics (min, max, mean, counts)                          │  │   │
│  │   └──────────────────────────────────────────────────────────────────────────┘  │   │
│  │                                           │                                      │   │
│  │                                           ▼                                      │   │
│  │   Response (GeoJSON):                                                            │   │
│  │   ┌──────────────────────────────────────────────────────────────────────────┐  │   │
│  │   │  {                                                                        │  │   │
│  │   │    "success": true,                                                       │  │   │
│  │   │    "data": {                                                              │  │   │
│  │   │      "type": "FeatureCollection",                                         │  │   │
│  │   │      "features": [                                                        │  │   │
│  │   │        {                                                                  │  │   │
│  │   │          "type": "Feature",                                               │  │   │
│  │   │          "geometry": { "type": "Point", "coordinates": [-77.12, 39.04] }, │  │   │
│  │   │          "properties": {                                                  │  │   │
│  │   │            "probability": 0.73,                                           │  │   │
│  │   │            "riskLevel": "high",                                           │  │   │
│  │   │            "weight": 0.79                                                 │  │   │
│  │   │          }                                                                │  │   │
│  │   │        },                                                                 │  │   │
│  │   │        ...                                                                │  │   │
│  │   │      ]                                                                    │  │   │
│  │   │    },                                                                     │  │   │
│  │   │    "meta": { "count": 1234, "hour": 14, "day": 2, "stats": {...} }       │  │   │
│  │   │  }                                                                        │  │   │
│  │   └──────────────────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

### 5. Presentation Layer

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              PRESENTATION LAYER (React/Mapbox)                          │
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │                         PredictionLayer Component                                │   │
│  │                         src/components/map/PredictionLayer.tsx                   │   │
│  │                                                                                  │   │
│  │   ┌──────────────────────────────────────────────────────────────────────────┐  │   │
│  │   │                                                                           │  │   │
│  │   │   Props:                                                                  │  │   │
│  │   │   ┌─────────────────────────────────────────────────────────────────┐    │  │   │
│  │   │   │  visible: boolean     - Show/hide layer                         │    │  │   │
│  │   │   │  hour: number | null  - Hour to display (0-23)                  │    │  │   │
│  │   │   │  day: number | null   - Day of week (0-6)                       │    │  │   │
│  │   │   └─────────────────────────────────────────────────────────────────┘    │  │   │
│  │   │                                                                           │  │   │
│  │   │   Behavior:                                                               │  │   │
│  │   │   ┌─────────────────────────────────────────────────────────────────┐    │  │   │
│  │   │   │  1. On mount: Add source + layers to Mapbox map                 │    │  │   │
│  │   │   │  2. On map move: Fetch heatmap data for new bounds              │    │  │   │
│  │   │   │  3. On hour/day change: Refetch with new time params            │    │  │   │
│  │   │   │  4. On unmount: Remove layers + source from map                 │    │  │   │
│  │   │   └─────────────────────────────────────────────────────────────────┘    │  │   │
│  │   │                                                                           │  │   │
│  │   └──────────────────────────────────────────────────────────────────────────┘  │   │
│  │                                                                                  │   │
│  │   ┌──────────────────────────────────────────────────────────────────────────┐  │   │
│  │   │                       MAPBOX LAYERS                                       │  │   │
│  │   │                                                                           │  │   │
│  │   │   Layer 1: Heatmap (Low Zoom: 8-15)                                      │  │   │
│  │   │   ┌─────────────────────────────────────────────────────────────────┐    │  │   │
│  │   │   │                                                                  │    │  │   │
│  │   │   │   ┌─────────────────────────────────────────────────────────┐   │    │  │   │
│  │   │   │   │            Color Gradient by Probability                │   │    │  │   │
│  │   │   │   │                                                          │   │    │  │   │
│  │   │   │   │   0.0          0.3          0.5          0.7        1.0 │   │    │  │   │
│  │   │   │   │    │────────────│────────────│────────────│──────────│  │   │    │  │   │
│  │   │   │   │   ████████████████████████████████████████████████████  │   │    │  │   │
│  │   │   │   │   Transparent   Green      Yellow     Orange       Red  │   │    │  │   │
│  │   │   │   │                                                          │   │    │  │   │
│  │   │   │   └─────────────────────────────────────────────────────────┘   │    │  │   │
│  │   │   │                                                                  │    │  │   │
│  │   │   │   Properties:                                                   │    │  │   │
│  │   │   │   • heatmap-weight: Based on probability                        │    │  │   │
│  │   │   │   • heatmap-intensity: Increases with zoom                      │    │  │   │
│  │   │   │   • heatmap-radius: 15-40px based on zoom                       │    │  │   │
│  │   │   │   • heatmap-opacity: Fades at zoom > 14                         │    │  │   │
│  │   │   └─────────────────────────────────────────────────────────────────┘    │  │   │
│  │   │                                                                           │  │   │
│  │   │   Layer 2: Circles (High Zoom: 12+)                                      │  │   │
│  │   │   ┌─────────────────────────────────────────────────────────────────┐    │  │   │
│  │   │   │                                                                  │    │  │   │
│  │   │   │   Individual prediction points become visible:                  │    │  │   │
│  │   │   │                                                                  │    │  │   │
│  │   │   │       ●  Low Risk (green, 4px)                                  │    │  │   │
│  │   │   │       ●  Medium Risk (yellow, 8px)                              │    │  │   │
│  │   │   │       ●  High Risk (orange, 10px)                               │    │  │   │
│  │   │   │       ●  Very High Risk (red, 12px)                             │    │  │   │
│  │   │   │                                                                  │    │  │   │
│  │   │   │   Properties:                                                   │    │  │   │
│  │   │   │   • circle-color: Based on riskLevel property                   │    │  │   │
│  │   │   │   • circle-radius: 4-12px based on probability                  │    │  │   │
│  │   │   │   • circle-opacity: Increases at zoom > 14                      │    │  │   │
│  │   │   │   • circle-stroke: White, 2px                                   │    │  │   │
│  │   │   └─────────────────────────────────────────────────────────────────┘    │  │   │
│  │   │                                                                           │  │   │
│  │   └──────────────────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │                         MapFilterPanel Integration                               │   │
│  │                         src/components/map/MapFilterPanel.tsx                    │   │
│  │                                                                                  │   │
│  │   ┌──────────────────────────────────────────────────────────────────────────┐  │   │
│  │   │                                                                           │  │   │
│  │   │   Toggle Button:                                                          │  │   │
│  │   │   ┌───────────────────────────────────────────────────────────────────┐  │  │   │
│  │   │   │                                                                    │  │  │   │
│  │   │   │   [ Radar ] [ Laser ] [ Accidents ] [ 🔮 Risk Prediction ]        │  │  │   │
│  │   │   │                                          ▲                         │  │  │   │
│  │   │   │                                          │                         │  │  │   │
│  │   │   │                               Purple themed toggle                 │  │  │   │
│  │   │   │                               showPredictions state               │  │  │   │
│  │   │   │                                                                    │  │  │   │
│  │   │   └───────────────────────────────────────────────────────────────────┘  │  │   │
│  │   │                                                                           │  │   │
│  │   └──────────────────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

### 6. Complete Data Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              END-TO-END DATA FLOW                                       │
│                                                                                         │
│                                                                                         │
│   TRAINING FLOW (Batch - Weekly)                                                       │
│   ═══════════════════════════════                                                      │
│                                                                                         │
│   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐         │
│   │  PostgreSQL │     │   Feature   │     │   XGBoost   │     │  PostgreSQL │         │
│   │  Violations │────▶│ Engineering │────▶│  Training   │────▶│ Predictions │         │
│   │   (1M+)     │     │   (Python)  │     │  + Calibrate│     │   (~168K)   │         │
│   └─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘         │
│         │                   │                   │                   │                  │
│         │                   │                   │                   │                  │
│         ▼                   ▼                   ▼                   ▼                  │
│   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐         │
│   │ lat, lng,   │     │ grid_lat,   │     │ 5-fold CV   │     │ probability │         │
│   │ timestamp,  │     │ grid_lng,   │     │ AUC: 0.82   │     │ time_window │         │
│   │ speed_over, │     │ hour_sin,   │     │             │     │ factors     │         │
│   │ detection   │     │ hour_cos,   │     │ Calibration │     │ valid_until │         │
│   │ method      │     │ is_rush,    │     │ (Platt)     │     │             │         │
│   │             │     │ grid_count  │     │             │     │             │         │
│   └─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘         │
│                                                                                         │
│                                                                                         │
│   SERVING FLOW (Real-time - <100ms)                                                    │
│   ═════════════════════════════════                                                    │
│                                                                                         │
│   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐         │
│   │    User     │     │   Next.js   │     │  PostgreSQL │     │   Mapbox    │         │
│   │  (Browser)  │────▶│     API     │────▶│   Query     │────▶│   Render    │         │
│   └─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘         │
│         │                   │                   │                   │                  │
│         │                   │                   │                   │                  │
│         ▼                   ▼                   ▼                   ▼                  │
│   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐         │
│   │ Pan/zoom    │     │ Parse params│     │ Index scan  │     │ Heatmap or  │         │
│   │ map view    │     │ Build query │     │ WHERE time  │     │ circle      │         │
│   │             │     │ Format JSON │     │ AND bounds  │     │ layers      │         │
│   └─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘         │
│                                                                                         │
│                                                                                         │
│   LATENCY BREAKDOWN                                                                    │
│   ═════════════════                                                                    │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│   │                                                                                  │ │
│   │   Client Request ──▶ API Route ──▶ DB Query ──▶ JSON Format ──▶ Response       │ │
│   │        │                │              │            │              │            │ │
│   │       ~5ms            ~2ms          ~40ms         ~10ms          ~5ms           │ │
│   │                                                                                  │ │
│   │   Total: ~60ms (well under 100ms target)                                        │ │
│   │                                                                                  │ │
│   └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

### 7. Feature Importance & Model Interpretability

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              MODEL INTERPRETABILITY                                     │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│   │                       FEATURE IMPORTANCE (XGBoost)                               │ │
│   │                                                                                  │ │
│   │   grid_stop_count     ████████████████████████████████████  0.28                │ │
│   │   hour_sin            █████████████████████████             0.18                │ │
│   │   hour_cos            ████████████████████                  0.14                │ │
│   │   is_rush_hour        ███████████████████                   0.13                │ │
│   │   avg_speed_over      █████████████████                     0.11                │ │
│   │   radar_pct           ██████████████                        0.08                │ │
│   │   dow_sin             █████████                             0.05                │ │
│   │   is_weekend          ███████                               0.04                │ │
│   │                                                                                  │ │
│   │   Interpretation:                                                               │ │
│   │   • Historical stop density is strongest predictor                             │ │
│   │   • Time of day (cyclical) contributes ~32% combined                           │ │
│   │   • Rush hour and speed patterns are significant                               │ │
│   │                                                                                  │ │
│   └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│   │                       RISK LEVEL THRESHOLDS                                      │ │
│   │                                                                                  │ │
│   │   Probability Range        Risk Level          Color       API Response         │ │
│   │   ─────────────────        ──────────          ─────       ────────────         │ │
│   │   0.00 - 0.19              Low                 Green       "low"                │ │
│   │   0.20 - 0.39              Medium              Yellow      "medium"             │ │
│   │   0.40 - 0.69              High                Orange      "high"               │ │
│   │   0.70 - 1.00              Very High           Red         "very_high"          │ │
│   │                                                                                  │ │
│   └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│   │                       FACTOR CONTRIBUTION EXAMPLE                                │ │
│   │                                                                                  │ │
│   │   Location: 39.046, -77.120                                                     │ │
│   │   Time: Tuesday 2:00 PM (rush hour approaching)                                 │ │
│   │   Predicted Probability: 0.73 (High Risk)                                       │ │
│   │                                                                                  │ │
│   │   Contributing Factors:                                                         │ │
│   │   ┌───────────────────────────────────────────────────────────────────────┐    │ │
│   │   │                                                                        │    │ │
│   │   │   Base probability                           0.25                      │    │ │
│   │   │   + Historical density (145 stops)           +0.22                     │    │ │
│   │   │   + Rush hour approaching                    +0.15                     │    │ │
│   │   │   + Radar detection zone                     +0.12                     │    │ │
│   │   │   + Weekday                                  +0.04                     │    │ │
│   │   │   - Low speed average                        -0.05                     │    │ │
│   │   │   ──────────────────────────────────────────────────                   │    │ │
│   │   │   Final probability                          0.73                      │    │ │
│   │   │                                                                        │    │ │
│   │   └───────────────────────────────────────────────────────────────────────┘    │ │
│   │                                                                                  │ │
│   └─────────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

### 8. System Component Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              FILE STRUCTURE & DEPENDENCIES                              │
│                                                                                         │
│   PYTHON ML MODULE                           NEXT.JS APPLICATION                        │
│   ══════════════════                         ════════════════════                       │
│                                                                                         │
│   ml/                                        src/                                       │
│   ├── requirements.txt                       ├── app/                                   │
│   │   ├── pandas                             │   ├── (dashboard)/                       │
│   │   ├── numpy                              │   │   └── analytics/                     │
│   │   ├── scikit-learn                       │   │       └── page.tsx ◄────────────┐   │
│   │   ├── xgboost                            │   │           │                      │   │
│   │   ├── psycopg2-binary                    │   │           │ renders              │   │
│   │   ├── python-dotenv                      │   │           ▼                      │   │
│   │   ├── joblib                             │   └── api/                           │   │
│   │   └── tqdm                               │       └── predictions/               │   │
│   │                                          │           ├── risk/                  │   │
│   ├── feature_engineering.py                 │           │   └── route.ts ◄────┐   │   │
│   │   ├── round_to_grid()                    │           │       │             │   │   │
│   │   ├── cyclical_encode()                  │           │       │ queries     │   │   │
│   │   ├── encode_temporal_features()         │           │       ▼             │   │   │
│   │   └── create_training_data()             │           └── heatmap/          │   │   │
│   │       │                                  │               └── route.ts ◄──┐ │   │   │
│   │       │ imports                          │                   │           │ │   │   │
│   │       ▼                                  │                   │ queries   │ │   │   │
│   └── train_risk_model.py                    │                   ▼           │ │   │   │
│       ├── load_data()                        │                               │ │   │   │
│       ├── create_spatiotemporal_grid()       │   ┌─────────────────────────┐ │ │   │   │
│       ├── train_model()                      │   │     PostgreSQL          │ │ │   │   │
│       ├── calibrate_probabilities()          │   │  police_predictions     │◄┘ │   │   │
│       └── save_predictions()                 │   │                         │◄──┘   │   │
│           │                                  │   └─────────────────────────┘       │   │
│           │ writes to                        │                                     │   │
│           ▼                                  │   components/                       │   │
│   ┌───────────────────┐                      │   └── map/                          │   │
│   │    PostgreSQL     │                      │       ├── PredictionLayer.tsx ──────┘   │
│   │ police_predictions│◄─────────────────────┤       │   │                             │
│   └───────────────────┘                      │       │   │ fetches from                │
│                                              │       │   │ /api/predictions/heatmap   │
│                                              │       │   │                             │
│                                              │       └── MapFilterPanel.tsx            │
│                                              │           │                             │
│                                              │           │ controls                    │
│                                              │           │ showPredictions             │
│                                              │           ▼                             │
│                                              │       ┌────────────────────────────┐   │
│                                              │       │    PredictionLayer         │   │
│                                              │       │    visible={showPredictions}│   │
│                                              │       └────────────────────────────┘   │
│                                              │                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

### 9. Operational Commands

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              OPERATIONAL WORKFLOW                                       │
│                                                                                         │
│   INITIAL SETUP                                                                        │
│   ═════════════                                                                        │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│   │                                                                                  │ │
│   │   $ npm run ml:setup                                                            │ │
│   │   # Installs Python dependencies from ml/requirements.txt                       │ │
│   │                                                                                  │ │
│   │   $ npm run ml:train                                                            │ │
│   │   # Trains model and populates police_predictions table                         │ │
│   │                                                                                  │ │
│   │   Expected output:                                                              │ │
│   │   ┌────────────────────────────────────────────────────────────────────────┐   │ │
│   │   │  Loading data from PostgreSQL...                                        │   │ │
│   │   │  Found 1,234,567 violations                                             │   │ │
│   │   │  Creating spatiotemporal grid...                                        │   │ │
│   │   │  Generated 168,000 grid-time combinations                               │   │ │
│   │   │  Training XGBoost model...                                              │   │ │
│   │   │  Cross-validation AUC: 0.82 (+/- 0.015)                                 │   │ │
│   │   │  Calibrating probabilities...                                           │   │ │
│   │   │  Generating predictions...                                              │   │ │
│   │   │  Inserted 168,000 predictions to database                               │   │ │
│   │   │  Model version: v1.0.0                                                  │   │ │
│   │   │  Training completed in 4m 32s                                           │   │ │
│   │   └────────────────────────────────────────────────────────────────────────┘   │ │
│   │                                                                                  │ │
│   └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                         │
│   WEEKLY RETRAINING (Recommended)                                                      │
│   ═══════════════════════════════                                                      │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│   │                                                                                  │ │
│   │   Cron job (example):                                                           │ │
│   │   0 2 * * 0 cd /path/to/project && npm run ml:train >> /var/log/ml-train.log   │ │
│   │   # Runs every Sunday at 2 AM                                                   │ │
│   │                                                                                  │ │
│   │   Why weekly?                                                                   │ │
│   │   • New violations accumulate                                                   │ │
│   │   • Enforcement patterns may shift                                              │ │
│   │   • Predictions have 7-day validity (valid_until)                              │ │
│   │                                                                                  │ │
│   └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                         │
│   MONITORING                                                                           │
│   ══════════                                                                           │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│   │                                                                                  │ │
│   │   # Check prediction count                                                      │ │
│   │   SELECT COUNT(*), time_window                                                  │ │
│   │   FROM police_predictions                                                       │ │
│   │   WHERE valid_until > NOW()                                                     │ │
│   │   GROUP BY time_window;                                                         │ │
│   │                                                                                  │ │
│   │   # Check probability distribution                                              │ │
│   │   SELECT                                                                        │ │
│   │     CASE                                                                        │ │
│   │       WHEN probability < 0.2 THEN 'low'                                         │ │
│   │       WHEN probability < 0.4 THEN 'medium'                                      │ │
│   │       WHEN probability < 0.7 THEN 'high'                                        │ │
│   │       ELSE 'very_high'                                                          │ │
│   │     END as risk_level,                                                          │ │
│   │     COUNT(*)                                                                    │ │
│   │   FROM police_predictions                                                       │ │
│   │   WHERE valid_until > NOW()                                                     │ │
│   │   GROUP BY risk_level;                                                          │ │
│   │                                                                                  │ │
│   └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Summary Statistics

| Component | Technology | Purpose |
|-----------|------------|---------|
| Data Source | PostgreSQL | 1M+ traffic violations |
| Feature Engineering | Python/Pandas | Spatial + temporal + contextual features |
| ML Model | XGBoost + Calibration | Binary classification (stop/no-stop) |
| Prediction Storage | PostgreSQL | ~168K pre-computed predictions |
| Risk API | Next.js | Point-based risk queries |
| Heatmap API | Next.js | Viewport-based GeoJSON |
| Visualization | React/Mapbox | Heatmap + circle layers |

| Metric | Target | Achieved |
|--------|--------|----------|
| Model AUC | >0.75 | ~0.82 |
| API Latency | <100ms | ~60ms |
| Prediction Coverage | All grid×time | 168K combinations |
| Update Frequency | Weekly | Configurable |
